/*!
(c) Michael Phan-Ba
github.com/mikepb/clerk
Apache License
*/
(function(encodeURI,encodeURIComponent,decodeURIComponent){var global=this;var extend=function(target){var source,key,i=1;while(source=arguments[i++]){for(key in source)target[key]=source[key]}return target};var asString=function(that){return Object.prototype.toString.call(that)};var isString=function(that){return asString(that)=="[object String]"};var isObject=function(that){return asString(that)=="[object Object]"};var isArray=function(that){return asString(that)=="[object Array]"};var isFunction=function(that){return asString(that)=="[object Function]"};var clerk=function(uri){return clerk.make(uri)};var previousClerk=this.clerk;this.clerk=clerk;clerk.noConflict=function(){global.clerk=previousClerk;return clerk};clerk.version="0.6.0";clerk.make=function(uri){var client,db;uri=clerk._parseURI(uri);if(db=/\/*([^\/]+)\/*$/.exec(uri.path)){uri.path=uri.path.substr(0,db.index);db=db[1]&&decodeURIComponent(db[1])}client=new clerk.Client(uri.host+uri.path,uri);return db?client.db(db):client};clerk._parseURI=function(uri){var match;if(uri){if(match=/^(https?:\/\/)(?:([^@:]+):([^@]+)@)?([^\/]+)(.*)\/*$/.exec(uri)){return{host:match[1]+match[4].replace(/\/+/g,"/"),path:match[5],user:match[2]&&decodeURIComponent(match[2]),pass:match[3]&&decodeURIComponent(match[3])}}}return{host:uri||"",path:""}};clerk.Base=function(){};clerk.Base.prototype={request:function(){var args=[].slice.call(arguments),callback=isFunction(args[args.length-1])&&args.pop();return this._request({method:args[0],path:args[1],query:args[2],data:args[3],headers:args[4],fn:callback})},_request:function(options){if(!options.method)options.method="GET";if(!options.headers)options.headers={};options.path=options.path?"/"+options.path:"";if(!("Content-Type"in options.headers)){options.headers["Content-Type"]="application/json"}options.uri=this.uri+options.path;options.body=options.data&&JSON.stringify(options.data,/^\/_design/.test(options.path)&&this._replacer)||"";options.auth=this.auth||{};this._do(options);return this},_do:function(options){var self=this,xhr=new XMLHttpRequest,qval=[],header,key,value;if(options.query){for(key in options.query){if(typeof(value=options.query[key])==="object"){value=JSON.stringify(value)}key=encodeURIComponent(key);value=encodeURIComponent(value);qval.push(key+"="+value)}options.uri+="?"+qval.join("&")}xhr.open(options.method,options.uri,true,options.auth.user,options.auth.pass);if(options.headers){for(header in options.headers){xhr.setRequestHeader(header,options.headers[header])}}if(options.fn)xhr.onreadystatechange=function(){if(xhr.readyState===4){var headers=self._getHeaders(xhr),data=xhr.responseText,err;if(options.method=="HEAD"){data=headers}else if(data){try{data=JSON.parse(data)}catch(e){err=e}if(!err){if(data.error)err=self._error(data);else data=self._response(data)}}options.fn(err,data,xhr.status,headers,xhr)}};xhr.send(options.body)},_response:function(json){var data=json.rows||json.results||json.uuids||isArray(json)&&json,meta=this._meta,i=0,len,item;if(data){data=[].slice.call(data);extend(data.__proto__=[],json).json=json;for(len=data.length;i<len;i++){item=data[i]=meta(data[i]);if(json.rows&&item.doc)item.doc=meta(item.doc)}}else{data=meta(json)}return data},_error:function(json){return extend(new Error(json.error+": "+json.reason),json)},_replacer:function(key,val){return isFunction(val)?val.toString():val},_meta:function(doc){var hasId=!doc.id^!doc._id,hasRev=!doc.rev^!doc._rev,proto;if(hasId||hasRev){proto=function(){};doc=extend(new proto,doc);proto=proto.prototype;if(hasId)proto._id=doc._id||doc.id;if(hasRev)proto._rev=doc._rev||doc.rev}return doc},_headers:["cache-control","content-length","content-type","date","etag","server"],_getHeaders:function(xhr){var headers={},header,i=0;while(header=this._headers[i++]){headers[header]=xhr.getResponseHeader(header)}return headers},_:function(args,start,withDoc){var self=this,doc,id,rev;function request(method,path,options){if(!options)options={};return self._request({method:method,path:path||request.p,query:options.q||request.q,data:options.b||request.b,headers:options.h||request.h,fn:options.f||request.f,state:request})}args=[].slice.call(args,start||0);request.f=isFunction(args[args.length-1])&&args.pop();request.p=isString(args[0])&&encodeURI(args.shift());request.q=args[withDoc?1:0]||{};request.h=args[withDoc?2:1]||{};if(withDoc){if(doc=request.b=args[0]){if(id=request.p||doc._id||doc.id)request.p=id;if(rev=request.q.rev||doc._rev||doc.rev)request.q.rev=rev}}return request}};clerk.Client=function(uri,auth){this.uri=uri;this.auth=auth;this._db={}};clerk.Client.prototype=extend(new clerk.Base,{db:function(name){var db=this._db;return db[name]||(db[name]=new clerk.DB(this,name,this.auth))},dbs:function(){return this._(arguments)("GET","_all_dbs")},uuids:function(count){var request=this._(arguments,+count==count?1:0);if(count>1)request.q.count=count;return request("GET","_uuids")},info:function(){return this._(arguments)("GET")},stats:function(){return this._(arguments)("GET","_stats")},log:function(){var request=this._(arguments),callback=request.f;if(!callback)return this;request.f=function(e){if(e instanceof SyntaxError)e=null;callback.apply(this,arguments)};return request("GET","_log")},tasks:function(){return this._(arguments)("GET","_active_tasks")},config:function(){var args=[].slice.call(arguments),key=isString(args[0])&&args.shift()||"",value=isString(args[0])&&args.shift(),method=isString(value)?"PUT":"GET";return this._(args)(method,"_config/"+key,{b:value})},replicate:function(options){return this._(arguments,1)("POST","_replicate",{b:options})}});clerk.DB=function(client,name,auth){this.client=client;this.name=name;this.uri=client.uri+"/"+encodeURIComponent(name);this.auth=auth};clerk.DB.prototype=extend(new clerk.Base,{create:function(){return this._(arguments)("PUT")},destroy:function(){return this._(arguments)("DELETE")},info:function(){return this._(arguments)("GET")},exists:function(){var request=this._(arguments),callback=request.f;if(!callback)return this;request.f=function(err,body,status,headers,xhr){callback(err,status===200,status,headers,xhr)};return request("HEAD")},get:function(){return this._(arguments)("GET")},head:function(){var self=this,request=self._(arguments),callback=request.f,id=request.p,rev;if(!callback)return this;request.f=function(err,body,status,headers,xhr){callback(err,err?body:self._meta({_id:id,_rev:headers.etag&&JSON.parse(headers.etag),contentType:headers["content-type"],contentLength:headers["content-length"]}),status,headers,xhr)};return request("HEAD")},post:function(docs){var request=this._(arguments,1);if(isArray(docs)){var callback=request.f;request.p="_bulk_docs";request.b=extend({docs:docs},request.q);request.q=null;if(callback)request.f=function(err,body){if(!err){var i=0,len=body.length,doc;for(;i<len;i++){doc=body[i];if(!doc.error)doc.ok=true}}callback.apply(this,arguments)}}else{request.b=docs}return request("POST")},put:function(){var request=this._(arguments,0,1);if(!request.p)request.p=request.b._id||request.b.id;if(!request.p)throw new Error("missing id");return request("PUT")},del:function(docs){if(isArray(docs)){var i=0,len=docs.length,doc;for(;i<len;i++){doc=docs[i],docs[i]={_id:doc._id||doc.id,_rev:doc._rev||doc.rev,_deleted:true}}return this.post.apply(this,arguments)}else{var request=this._(arguments,0,1);if(!request.p)throw new Error("missing id");return request("DELETE")}},copy:function(source,target){var request=this._(arguments,2),sourcePath=encodeURIComponent(source.id||source._id||source),targetPath=encodeURIComponent(target.id||target._id||target),sourceRev=source.rev||source._rev,targetRev=target.rev||target._rev,callback=request.f;if(sourceRev)request.q.rev=sourceRev;if(targetRev)targetPath+="?rev="+encodeURIComponent(targetRev);request.h.Destination=targetPath;if(callback)request.f=function(err,body){if(!err)body.ok=true;callback.apply(this,arguments)};return request("COPY",sourcePath)},all:function(){var request=this._(arguments),body=this._viewOptions(request.q);return request(body?"POST":"GET","_all_docs",{b:body})},find:function(view){var request=this._(arguments,1),path,body;if(isString(view)){path=view.split("/",2);path="_design/"+encodeURIComponent(path[0])+"/_view/"+encodeURIComponent(path[1])}else{path="_temp_view";body=view}body=this._viewOptions(request.q,body);return request(body?"POST":"GET",path,{b:body})},changes:function(){var request=this._(arguments);if(request.q.feed!="longpoll")delete request.q.feed;return this._changes(request)},follow:function(){var request=this._(arguments),callback=request.f;if(!callback)return this;request.q.feed="longpoll";request.f=function(err,doc){var body=doc,i=0,len=doc.length,stop;for(;i<len;i++){doc=body[i];if(stop=callback.apply(this,arguments)===false||err)break}if(!stop)this._changes(request)};return this._changes(request)},_changes:function(request){return request("GET","_changes")},update:function(handler){var request=this._(arguments,1,1),path=handler.split("/",2);path="_design/"+encodeURIComponent(path[0])+"/_update/"+encodeURIComponent(path[1]);if(request.p)path+="/"+request.p;return request(request.p?"PUT":"POST",path,{q:request.b,b:request.q})},attachment:function(doc,attachmentName){var request=this._(arguments,2);var path=encodeURIComponent(doc._id||doc.id||doc)+"/"+encodeURIComponent(attachmentName);return request("GET",path,options)},attach:function(doc,attachmentName,data){var request=this._(arguments,3);request.p=encodeURIComponent(doc._id||doc.id)+"/"+encodeURIComponent(attachmentName);if(!request.q.rev)request.q.rev=doc._rev||doc.rev;request.q.body=data;return request("PUT",path)},replicate:function(options){if(!options.source)options.source=this.name;if(!options.target)options.target=this.name;return this.client.replicate.apply(this.client,arguments)},commit:function(){return this._(arguments)("POST","_ensure_full_commit")},purge:function(revs){return this._(arguments,1)("POST","_purge",{b:revs})},compact:function(){var request=this._(arguments);return request("POST","_compact/"+(request.p||""))},vacuum:function(){return this._(arguments)("POST","_view_cleanup")},_viewOptions:function(q,body){if(q){if(q.key)q.key=JSON.stringify(q.key);if(q.startkey)q.startkey=JSON.stringify(q.startkey);if(q.endkey)q.endkey=JSON.stringify(q.endkey);if(q.stale&&q.stale!="update_after")q.stale="ok";if(q.keys){if(!body)body={};body.keys=q.keys;delete q.keys}}return body}})})(encodeURI,encodeURIComponent,decodeURIComponent);
//# sourceMappingURL=clerk.min.js.map