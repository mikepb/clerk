/*
(c) Michael Phan-Ba
github.com/mikepb/clerk
Apache License
*/(function(a,b,c,d){function n(a){var b=l.call(arguments,1),c,d,e=0;while(c=b[e++])for(d in c)a[d]=c[d];return a}function o(a){return Object.prototype.toString.call(a)}function p(a){return o(a)=="[object String]"}function q(a){return o(a)=="[object Object]"}function r(a){return o(a)=="[object Array]"}function s(a){return o(a)=="[object Function]"}function t(a){if(!a||p(a))return t.make(a);var b=[],c,d=0,e;for(c in a)a[c]=t.make(a[c]),b.push(c);return e=b.length,function(c){var f;c||(c=b[d++],d%=e);if(!(f=a[c]))throw new Error("no server configured");return f}}var e=this,f="GET",g="HEAD",h="POST",i="PUT",j="DELETE",k="COPY",l=[].slice,m=e.clerk;e.clerk=t,a&&(a.exports=t),t.noConflict=function(){return e.clerk=m,t},t.version="0.2.0",t.make=function(a){var b,c;a=t._parseURI(a);if(c=/^(https?:\/\/[^\/]+).*?(\/[^\/]+)?$/.exec(a.host))a.host=c[1],c=c[2]&&d(c[2]);return b=new t.Client(a.host,a),c?b.database(c):b},t._parseURI=function(a){var b;if(a){a=a.replace(/\/+/g,"/").replace(/\/+$/g,"");if(b=/^(https?:\/\/)(?:([^@:]+):([^@]+)@)?([^\/]+)(.*)$/.exec(a))return{host:b[1]+b[4],user:b[2]&&d(b[2]),pass:b[3]&&d(b[3])}}return{host:a||""}};var u=t.Base={request:function(){var a=this,b=l.call(arguments),c=s(b[b.length-1])&&b.pop(),d=b[4]||{},e=b[1]?"/"+b[1]:"";return"Content-Type"in d||(d["Content-Type"]="application/json"),a._request(b[0]||f,a.uri+e,b[2],b[3]&&JSON.stringify(b[3],/^\/_design/.test(e)&&a._replacer)||"",d,a.auth||{},c),a},_request:function(a,b,d,e,f,h,i){var j=this,k=new XMLHttpRequest,l=[],m,n;if(d){for(n in d)l.push(c(n)+"="+c(d[n]));l.length&&(b+="?"+l.join("&"))}k.open(a,b,!0,h.user,h.pass);if(f)for(m in f)k.setRequestHeader(m,f[m]);k.onreadystatechange=function(){if(i&&k.readyState===4){var b=j._getHeaders(k),c=k.responseText,d;if(a==g)c=b;else if(c)try{c=JSON.parse(c)}catch(e){d=e}d||(c=j._response(c)),i(d,c,k.status,b,k)}},k.send(e)},_response:function(a){var b=a.rows||a.results||a.uuids||r(a)&&a,c=this._meta,d=0,e,f;if(b){for(e=b.length;d<e;d++)f=b[d]=c(b[d]),a.rows&&f.doc&&(f.doc=c(f.doc));b=l.call(b),n(b.__proto__=[],a).json=a}else b=c(a);return b},_replacer:function(a,b){return s(b)?b.toString():b},_meta:function(a){var b=!a.id^!a._id,c=!a.rev^!a._rev,d;if(b||c)d=n(a.__proto__={},a),b&&(d._id=a.id=a._id||a.id),c&&(d._rev=a.rev=a._rev||a.rev);return a},_headers:["cache-control","content-length","content-type","date","etag","server"],_getHeaders:function(a){var b={},c,d=0;while(c=this._headers[d++])b[c]=a.getResponseHeader(c);return b},_:function(a,c,d){function i(a,b,c){return c||(c={}),e.request(a,b||i.p,"q"in c?c.q:i.q,"b"in c?c.b:i.b,"h"in c?c.h:i.h,"f"in c?c.f:i.f),e}var e=this,f,g,h;a=l.call(a,c),i.f=s(a[a.length-1])&&a.pop(),i.p=p(a[0])&&b(a.shift()),i.q=a[d?1:0]||{},i.h=a[d?2:1]||{};if(d)if(f=i.b=a[0]){if(g=i.p||f._id||f.id)i.p=g;if(h=i.q.rev||f._rev||f.rev)i.q.rev=h}return i}},v=t.Client=function(a,b){this.uri=a,this.auth=b,this._db={}};v=v.prototype={database:function(a){var b=this,c=b._db;return c[a]||(c[a]=new t.Database(b,a,b.auth))},databases:function(){return this._(arguments)(f,"_all_dbs")},uuids:function(a){var b=this._(arguments,+a==a?1:0);return a>1&&(b.q.count=a),b(f,"_uuids")},info:function(){return this._(arguments)(f)},stats:function(){return this._(arguments)(f,"_stats")},log:function(){var a=this._(arguments),b=a.f;return a.f=function(a){a instanceof SyntaxError&&(a=null),b.apply(this,arguments)},a(f,"_log")},tasks:function(){return this._(arguments)(f,"_active_tasks")},config:function(){var a=this._(arguments,0,1);return a(a.b?i:f,"_config"+(a.p?"/"+a.p:""))},replicate:function(a){return this._(arguments,1)(h,"_replicate",{b:a})},restart:function(){return this._(arguments)(h,"_restart")}};var w=t.Database=function(a,b,d){this.client=a,this.name=b,this.uri=a.uri+"/"+c(b),this.auth=d};w=w.prototype={create:function(){return this._(arguments)(i)},destroy:function(){return this._(arguments)(j)},info:function(){return this._(arguments)(f)},exists:function(){var a=this._(arguments),b=a.f;return a.f=function(a,c,d,e,f){b(a,d===200,d,e,f)},a(g)},get:function(){return this._(arguments)(f)},head:function(){var a=this._(arguments),b=a.f,c=a.p,d;return a.f=function(a,e,f,g,h){b(a,a?e:{_id:c,id:c,_rev:d=g.etag&&JSON.parse(g.etag),rev:d,contentType:g["content-type"],contentLength:g["content-length"]},f,g,h)},a(g)},post:function(a){return this._(arguments,1)(h,0,{b:a})},put:function(){var a=this._(arguments,0,1);if(!a.p)throw new Error("missing id");return a(i)},del:function(a){var b=this._(arguments,0,1);if(!b.p)throw new Error("missing id");return b(j)},copy:function(a,b){var d=this._(arguments,2),e=c(a.id||a._id||a),f=c(b.id||b._id||b),g=a.rev||a._rev,h=b.rev||b._rev;return g&&(d.q.rev=g),h&&(f+="?rev="+c(h)),d.h.Destination=f,d(k,e)},all:function(){var a=this._(arguments),b=this._viewOptions(a.q);return a(b?h:f,"_all_docs",{b:b})},view:function(a){var b=this._(arguments,1),d,e;return p(a)?(d=a.split("/",2),d="_design/"+c(d[0])+"/_view/"+c(d[1])):(d="_temp_view",e=a),e=this._viewOptions(b.q,e),b(e?h:f,d,{b:e})},changes:function(){var a=this._(arguments);return a.q.feed!="longpoll"&&delete a.q.feed,this._changes(a)},follow:function(){var a=this,b=a._(arguments),c=b.f;return b.q.feed="longpoll",b.f=function(d,e){var f=e,g=0,h=e.length,i;for(;g<h;g++){e=f[g];if(i=c.apply(this,arguments)===!1||d)break}i||a._changes(b)},a._changes(b)},_changes:function(a){return a(f,"_changes")},bulk:function(a){var b=this._(arguments,1);return b.q.docs=a,b(h,"_bulk_docs",{q:0,b:b.q})},dels:function(a){var b=0,c=a.length,d;for(;b<c;b++)d=a[b],a[b]={_id:d._id||d.id,_rev:d._rev||d.rev,_deleted:!0};return this.bulk.apply(this,arguments)},update:function(a){var b=this._(arguments,1,1),d=a.split("/",2);return d="_design/"+c(d[0])+"/_update/"+c(d[1]),b.p&&(d+="/"+b.p),b(b.p?i:h,d,{q:b.b,b:b.q})},attachment:function(a,b){var d=this._(arguments,2),e=c(a._id||a.id||a)+"/"+c(b);return d("GET",e,options)},attach:function(a,b,d){var e=this._(arguments,3);return e.p=c(a._id||a.id)+"/"+c(b),e.q.rev||(e.q.rev=a._rev||a.rev),e.q.body=d,e(i,path)},replicate:function(a){var b=this,c=b.name,d=b.client;return a.source||(a.source=c),a.target||(a.target=c),d.replicate.apply(d,arguments)},commit:function(){return this._(arguments)(h,"_ensure_full_commit")},purge:function(a){return this._(arguments,1)(h,"_purge",{b:a})},compact:function(){var a=this._(arguments);return a(h,"_compact"+(a.p?"/"+a.p:""))},vacuum:function(){return this._(arguments)(h,"_view_cleanup")},_viewOptions:function(a,b){return a&&(a.key&&(a.key=JSON.stringify(a.key)),a.startkey&&(a.startkey=JSON.stringify(a.startkey)),a.endkey&&(a.endkey=JSON.stringify(a.endkey)),a.stale&&a.stale!="update_after"&&(a.stale="ok"),a.keys&&(b||(b={}),b.keys=a.keys,delete a.keys)),b}},v.__proto__=w.__proto__=t.Base})(typeof module!="undefined"&&module,encodeURI,encodeURIComponent,decodeURIComponent);