/*
(c) Michael Phan-Ba
github.com/mikepb/clerk
Apache License
*/(function(a,b,c){function f(a){var b,c,d=1;while(b=arguments[d++])for(c in b)a[c]=b[c];return a}function g(a){return Object.prototype.toString.call(a)}function h(a){return g(a)=="[object String]"}function i(a){return g(a)=="[object Object]"}function j(a){return g(a)=="[object Array]"}function k(a){return g(a)=="[object Function]"}function l(a){return l.make(a)}var d=this,e=this.clerk;this.clerk=l,l.noConflict=function(){return d.clerk=e,l},l.version="0.3.2",l.make=function(a){var b,d;a=l._parseURI(a);if(d=/\/*([^\/]+)\/*$/.exec(a.path))a.path=a.path.substr(0,d.index),d=d[1]&&c(d[1]);return b=new l.Client(a.host+a.path,a),d?b.db(d):b},l._parseURI=function(a){var b;if(a)if(b=/^(https?:\/\/)(?:([^@:]+):([^@]+)@)?([^\/]+)(.*)\/*$/.exec(a))return{host:b[1]+b[4].replace(/\/+/g,"/").replace(/\/+$/g,""),path:b[5],user:b[2]&&c(b[2]),pass:b[3]&&c(b[3])};return{host:a||""}},l.Base=function(){},l.Base.prototype={request:function(){var a=[].slice.call(arguments),b=k(a[a.length-1])&&a.pop(),c=a[4]||{},d=a[1]?"/"+a[1]:"";return"Content-Type"in c||(c["Content-Type"]="application/json"),this._request(a[0]||"GET",this.uri+d,a[2],a[3]&&JSON.stringify(a[3],/^\/_design/.test(d)&&this._replacer)||"",c,this.auth||{},b),this},_request:function(a,c,d,e,f,g,h){var i=this,j=new XMLHttpRequest,k=[],l,m;if(d){for(m in d)k.push(b(m)+"="+b(d[m]));c+="?"+k.join("&")}j.open(a,c,!0,g.user,g.pass);if(f)for(l in f)j.setRequestHeader(l,f[l]);j.onreadystatechange=function(){if(h&&j.readyState===4){var b=i._getHeaders(j),c=j.responseText,d;if(a=="HEAD")c=b;else if(c)try{c=JSON.parse(c)}catch(e){d=e}!d&&c&&(c=i._response(c)),h(d,c,j.status,b,j)}},j.send(e)},_response:function(a){var b=a.rows||a.results||a.uuids||j(a)&&a,c=this._meta,d=0,e,g;if(b){b=[].slice.call(b),f(b.__proto__=[],a).json=a;for(e=b.length;d<e;d++)g=b[d]=c(b[d]),a.rows&&g.doc&&(g.doc=c(g.doc))}else b=c(a);return b},_replacer:function(a,b){return k(b)?b.toString():b},_meta:function(a){var b=!a.id^!a._id,c=!a.rev^!a._rev,d;if(b||c)d=f(a.__proto__={},a),b&&(d._id=a.id=a._id||a.id),c&&(d._rev=a.rev=a._rev||a.rev);return a},_headers:["cache-control","content-length","content-type","date","etag","server"],_getHeaders:function(a){var b={},c,d=0;while(c=this._headers[d++])b[c]=a.getResponseHeader(c);return b},_:function(b,c,d){function j(a,b,c){return c||(c={}),e.request(a,b||j.p||"","q"in c?c.q:j.q,"b"in c?c.b:j.b,"h"in c?c.h:j.h,"f"in c?c.f:j.f),e}var e=this,f,g,i;b=[].slice.call(b,c),j.f=k(b[b.length-1])&&b.pop(),j.p=h(b[0])&&a(b.shift()),j.q=b[d?1:0]||{},j.h=b[d?2:1]||{};if(d)if(f=j.b=b[0]){if(g=j.p||f._id||f.id)j.p=g;if(i=j.q.rev||f._rev||f.rev)j.q.rev=i}return j}},l.Client=function(a,b){this.uri=a,this.auth=b,this._db={}},l.Client.prototype=f(new l.Base,{db:function(a){var b=this._db;return b[a]||(b[a]=new l.DB(this,a,this.auth))},dbs:function(){return this._(arguments)("GET","_all_dbs")},uuids:function(a){var b=this._(arguments,+a==a?1:0);return a>1&&(b.q.count=a),b("GET","_uuids")},info:function(){return this._(arguments)("GET")},stats:function(){return this._(arguments)("GET","_stats")},log:function(){var a=this._(arguments),b=a.f;return a.f=function(a){a instanceof SyntaxError&&(a=null),b.apply(this,arguments)},a("GET","_log")},tasks:function(){return this._(arguments)("GET","_active_tasks")},config:function(){var a=[].slice.call(arguments),b=h(a[0])&&a.shift()||"",c=h(a[0])&&a.shift();return this._(a)(c?"PUT":"GET","_config/"+b,{b:c})},replicate:function(a){return this._(arguments,1)("POST","_replicate",{b:a})}}),l.DB=function(a,c,d){this.client=a,this.name=c,this.uri=a.uri+"/"+b(c),this.auth=d},l.DB.prototype=f(new l.Base,{create:function(){return this._(arguments)("PUT")},destroy:function(){return this._(arguments)("DELETE")},info:function(){return this._(arguments)("GET")},exists:function(){var a=this._(arguments),b=a.f;return a.f=function(a,c,d,e,f){b(a,d===200,d,e,f)},a("HEAD")},get:function(){return this._(arguments)("GET")},head:function(){var a=this._(arguments),b=a.f,c=a.p,d;return a.f=function(a,e,f,g,h){b(a,a?e:{_id:c,id:c,_rev:d=g.etag&&JSON.parse(g.etag),rev:d,contentType:g["content-type"],contentLength:g["content-length"]},f,g,h)},a("HEAD")},post:function(a){var b=this._(arguments,1);return j(a)?(b.p="_bulk_docs",b.b={docs:a}):b.b=a,b("POST")},put:function(){var a=this._(arguments,0,1);a.p||(a.p=a.b._id||a.b.id);if(!a.p)throw new Error("missing id");return a("PUT")},del:function(a){if(j(a)){var b=0,c,d;for(c=a.length;b<c;b++)d=a[b],a[b]={_id:d._id||d.id,_rev:d._rev||d.rev,_deleted:!0};return this.post.apply(this,arguments)}var e=this._(arguments,0,1);if(!e.p)throw new Error("missing id");return e("DELETE")},copy:function(a,c){var d=this._(arguments,2),e=b(a.id||a._id||a),f=b(c.id||c._id||c),g=a.rev||a._rev,h=c.rev||c._rev;return g&&(d.q.rev=g),h&&(f+="?rev="+b(h)),d.h.Destination=f,d("COPY",e)},all:function(){var a=this._(arguments),b=this._viewOptions(a.q);return a(b?"POST":"GET","_all_docs",{b:b})},find:function(a){var c=this._(arguments,1),d,e;return h(a)?(d=a.split("/",2),d="_design/"+b(d[0])+"/_view/"+b(d[1])):(d="_temp_view",e=a),e=this._viewOptions(c.q,e),c(e?"POST":"GET",d,{b:e})},changes:function(){var a=this._(arguments);return a.q.feed!="longpoll"&&delete a.q.feed,this._changes(a)},follow:function(){var a=this._(arguments),b=a.f;return a.q.feed="longpoll",a.f=function(c,d){var e=d,f=0,g=d.length,h;for(;f<g;f++){d=e[f];if(h=b.apply(this,arguments)===!1||c)break}h||this._changes(a)},this._changes(a)},_changes:function(a){return a("GET","_changes")},update:function(a){var c=this._(arguments,1,1),d=a.split("/",2);return d="_design/"+b(d[0])+"/_update/"+b(d[1]),c.p&&(d+="/"+c.p),c(c.p?"PUT":"POST",d,{q:c.b,b:c.q})},attachment:function(a,c){var d=this._(arguments,2),e=b(a._id||a.id||a)+"/"+b(c);return d("GET",e,options)},attach:function(a,c,d){var e=this._(arguments,3);return e.p=b(a._id||a.id)+"/"+b(c),e.q.rev||(e.q.rev=a._rev||a.rev),e.q.body=d,e("PUT",path)},replicate:function(a){return a.source||(a.source=this.name),a.target||(a.target=this.name),this.client.replicate.apply(this.client,arguments)},commit:function(){return this._(arguments)("POST","_ensure_full_commit")},purge:function(a){return this._(arguments,1)("POST","_purge",{b:a})},compact:function(){var a=this._(arguments);return a("POST","_compact/"+(a.p||""))},vacuum:function(){return this._(arguments)("POST","_view_cleanup")},_viewOptions:function(a,b){return a&&(a.key&&(a.key=JSON.stringify(a.key)),a.startkey&&(a.startkey=JSON.stringify(a.startkey)),a.endkey&&(a.endkey=JSON.stringify(a.endkey)),a.stale&&a.stale!="update_after"&&(a.stale="ok"),a.keys&&(b||(b={}),b.keys=a.keys,delete a.keys)),b}})})(encodeURI,encodeURIComponent,decodeURIComponent);